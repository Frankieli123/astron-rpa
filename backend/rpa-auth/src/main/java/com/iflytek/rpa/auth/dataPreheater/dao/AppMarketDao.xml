<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iflytek.rpa.auth.dataPreheater.dao.AppMarketDao">

    <resultMap type="com.iflytek.rpa.auth.dataPreheater.entity.AppMarket" id="AppMarketMap">
        <result property="id" column="id" jdbcType="INTEGER"/>
        <result property="marketName" column="market_name" jdbcType="VARCHAR"/>
        <result property="marketShare" column="market_share" jdbcType="VARCHAR"/>
        <result property="appShare" column="app_share" jdbcType="VARCHAR"/>
        <result property="marketDescribe" column="market_describe" jdbcType="VARCHAR"/>
        <result property="marketType" column="market_type" jdbcType="VARCHAR"/>
        <result property="creatorId" column="creator_id" jdbcType="CHAR"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updaterId" column="updater_id" jdbcType="CHAR"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
        <result property="deleted" column="deleted" jdbcType="INTEGER"/>
        <result property="marketId" column="market_id" jdbcType="VARCHAR"/>
        <result property="tenantId" column="tenant_id" jdbcType="CHAR"/>
        <result property="userPhone" column="user_phone" jdbcType="VARCHAR"/>
    </resultMap>

    <insert id="addMarketWithType" keyProperty="id" useGeneratedKeys="true">
        insert into app_market (tenant_id,
        market_id,
        market_name,
        market_describe,
        market_type,
        creator_id,
        create_time,
        updater_id,
        update_time,
        deleted)
        values
        (#{entity.tenantId},
        #{entity.marketId},
        #{entity.marketName},
        #{entity.marketDescribe},
        #{entity.marketType},
        #{entity.creatorId},
        now(),
        #{entity.updaterId},
        now(),
        0)
    </insert>


    <select id="selectPublicMarket" resultMap="AppMarketMap">
        select
            market_name,
            market_id,
            market_describe,
            create_time,
            creator_id
            market_type,
            creator_id,
            create_time,
            updater_id,
            update_time
        from
            app_market
        where
            market_type = 'public' and deleted = 0 and tenant_id = #{tenantId}
        limit 1
    </select>


    <!--通过主键修改数据-->
    <update id="update">
        update app_market
        <set>
            <if test="marketName != null and marketName != ''">
                market_name = #{marketName},
            </if>
            <if test="marketShare != null and marketShare != ''">
                market_share = #{marketShare},
            </if>
            <if test="appShare != null and appShare != ''">
                app_share = #{appShare},
            </if>
            <if test="marketDescribe != null and marketDescribe != ''">
                market_describe = #{marketDescribe},
            </if>
            <if test="marketType != null and marketType != ''">
                market_type = #{marketType},
            </if>
            <if test="creatorId != null">
                creator_id = #{creatorId},
            </if>
            <if test="createTime != null">
                create_time = #{createTime},
            </if>
            <if test="updaterId != null">
                updater_id = #{updaterId},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="deleted != null">
                deleted = #{deleted},
            </if>
        </set>
        where id = #{id}
    </update>

    <!--通过主键删除-->
    <delete id="deleteById">
        delete from app_market where id = #{id}
    </delete>

    <select id="getMarketCount" resultType="java.lang.Integer">
        select count(1)
        from app_market as am
        inner join app_market_user amu on amu.market_id = am.market_id and amu.tenant_id = am.tenant_id and amu.user_type = 'owner'
        where am.deleted = 0 and amu.deleted = 0  and am.tenant_id = #{tenantId}
    </select>

</mapper>

