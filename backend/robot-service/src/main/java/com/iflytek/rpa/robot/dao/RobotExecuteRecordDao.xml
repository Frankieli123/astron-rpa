<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iflytek.rpa.robot.dao.RobotExecuteRecordDao">

    <resultMap type="com.iflytek.rpa.robot.entity.RobotExecuteRecord" id="RobotExecuteRecordMap">
        <result property="id" column="id" jdbcType="INTEGER"/>
        <result property="executeId" column="execute_id" jdbcType="VARCHAR"/>
        <result property="robotId" column="robot_id" jdbcType="VARCHAR"/>
        <result property="robotName" column="robot_name" jdbcType="VARCHAR"/>
        <result property="robotVersion" column="robot_version" jdbcType="VARCHAR"/>
        <result property="startTime" column="start_time" jdbcType="TIMESTAMP"/>
        <result property="endTime" column="end_time" jdbcType="TIMESTAMP"/>
        <result property="executeTime" column="execute_time" jdbcType="INTEGER"/>
        <result property="mode" column="mode" jdbcType="VARCHAR"/>
        <result property="taskExecuteId" column="task_execute_id" jdbcType="INTEGER"/>
        <result property="result" column="result" jdbcType="VARCHAR"/>
        <result property="errorReason" column="error_reason" jdbcType="VARCHAR"/>
        <result property="executeLog" column="execute_log" jdbcType="VARCHAR"/>
        <result property="dataTablePath" column="data_table_path" jdbcType="VARCHAR"/>
        <result property="creatorId" column="creator_id" jdbcType="CHAR"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updaterId" column="updater_id" jdbcType="CHAR"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
        <result property="deleted" column="deleted" jdbcType="INTEGER"/>
        <result property="tenantId" column="tenant_id" jdbcType="CHAR"/>
        <result property="terminalId" column="terminal_id" jdbcType="CHAR"/>
    </resultMap>

    <select id="getExecuteRecordList" resultMap="RobotExecuteRecordMap">
        select rer.id,
        rer.execute_id,
        rer.task_execute_id,
        rer.robot_id,
        rer.robot_version,
        re.name as robot_name,
        rer.start_time,
        rer.end_time,
        rer.execute_time,
        rer.mode,
        rer.result,
        rer.video_local_path,
        rer.data_table_path
        from robot_execute_record rer
        left join robot_execute re on rer.robot_id = re.robot_id
        where
        rer.deleted=0
        and rer.creator_id = #{entity.creatorId}
        and rer.tenant_id = #{entity.tenantId}
        <if test="entity.robotId != null and entity.robotId != ''">
            and rer.robot_id = #{entity.robotId}
        </if>
        <if test="entity.robotName != null and entity.robotName != ''">
            and upper(re.name) like concat('%', upper(#{entity.robotName}), '%')
        </if>
        <!-- 新增：执行结果筛选 -->
        <if test="entity.result != null and entity.result != ''">
            and rer.result = #{entity.result}
        </if>
        <!-- 时间区间查询（整体一对） -->
        <if test="entity.startTime != null and entity.endTime != null">
            and rer.start_time >= #{entity.startTime}
            and rer.end_time <![CDATA[ <= ]]> #{entity.endTime}
        </if>
        <!-- 单独查询开始时间或结束时间 -->
        <if test="entity.startTime != null and entity.endTime == null">
            and rer.start_time >= #{entity.startTime}
        </if>
        <if test="entity.startTime == null and entity.endTime != null">
            and rer.end_time <![CDATA[ <= ]]> #{entity.endTime}
        </if>
        <choose>
            <when test="entity.sortBy !=null and entity.sortBy != ''">
                <if test="entity.sortType == 'descending'.toString()">
                    order by ${entity.sortBy} desc
                </if>
                <if test="entity.sortType == 'ascending'.toString() ">
                    order by ${entity.sortBy} asc
                </if>
            </when>
            <otherwise>
                order by start_time desc
            </otherwise>
        </choose>
    </select>

    <select id="getRecordByExecuteIdList" resultMap="RobotExecuteRecordMap">
        select rer.id,
               rer.execute_id,
            rer.task_execute_id,
            rer.robot_id,
            re.name as robot_name,
            rer.robot_version,
            rer.start_time,
            rer.end_time,
            rer.execute_time,
            rer.result,
            rer.execute_log,
            rer.video_local_path
        from robot_execute_record rer
        left join robot_execute re on rer.robot_id = re.robot_id
        <where>
            <!-- 优化：将选择性高的task_execute_id放在前面，deleted放在最后，与索引顺序一致 -->
            and rer.task_execute_id in
            <foreach collection="executeIdList" item="executeId" separator="," open="(" close=")">
                #{executeId}
            </foreach>
            <!-- deleted放在最后，因为选择性低（只有0/1，且1占大多数） -->
            and rer.deleted = 0
        </where>
    </select>

    <select id="robotOverview" resultType = "com.iflytek.rpa.monitor.entity.RobotMonitorDto">
        select count(*) executeTotal, sum(result = 'robotSuccess') executeSuccess, sum(result = 'robotFail') executeFail, sum(result = 'robotCancel') executeAbort
        from robot_execute_record
        <where>
            result in ('robotSuccess','robotFail','robotCancel')
            and tenant_id = #{tenantId}
            and robot_id = #{robotId}
            <if test="robotVersion != null">
                and robot_version= #{robotVersion}
            </if>
            and start_time &lt;= #{countTime}
        </where>
    </select>

    <select id="getExecuteLog" resultType="java.lang.String">
        select execute_log
        from
            robot_execute_record
        where
            execute_id = #{executeId}
        and creator_id = #{creatorId}
        and tenant_id = #{tenantId}
        limit 1
    </select>

    <select id="getExecuteRecord" resultMap="RobotExecuteRecordMap">
        select  *
        from robot_execute_record
        where
            deleted=0
            and execute_id = #{executeId}
            and creator_id = #{creatorId}
            and tenant_id = #{tenantId}
    </select>

    <insert id="insertExecuteRecord">
        insert into
            robot_execute_record
            (
             execute_id,
             robot_id,
             robot_version,
             start_time,
             end_time,
             execute_time,
             mode,
             task_execute_id,
             result,
             error_reason,
             execute_log,
             creator_id,
             create_time,
             updater_id,
             update_time,
             deleted,
             tenant_id,
             video_local_path,
             dept_id_path,
             terminal_id,
            data_table_path)
        values(#{executeId},
               #{robotId},
               #{robotVersion},
               #{startTime},
               #{endTime},
               #{executeTime},
               #{mode},
               #{taskExecuteId},
               #{result},
               #{errorReason},
               #{executeLog},
               #{creatorId},
               now(),
               #{updaterId},
               now(),
               0,
               #{tenantId},
               #{videoLocalPath},
               #{deptIdPath},
               #{terminalId},
               #{dataTablePath})
    </insert>


    <update id="updateExecuteRecord">
        update robot_execute_record
        set
            <if test="endTime != null">
                    end_time = #{endTime},
            </if>
            <if test="executeTime != null">
                    execute_time = #{executeTime},
            </if>
            <if test="taskExecuteId != null">
                task_execute_id = #{taskExecuteId},
            </if>
            <if test="result != null and result != ''">
                    result = #{result},
            </if>
            <if test="errorReason != null and errorReason != ''">
                    error_reason = #{errorReason},
            </if>
            <if test="executeLog != null and executeLog != ''">
                    execute_log = #{executeLog},
            </if>
            <if test="videoLocalPath != null and videoLocalPath != ''">
                    video_local_path = #{videoLocalPath},
            </if>
            <if test="dataTablePath != null">
                data_table_path = #{dataTablePath},
            </if>
            <if test="updaterId != null">
                    updater_id = #{updaterId},
            </if>
                    update_time = now()
        where
            execute_id = #{executeId}
        and creator_id = #{creatorId}
        and tenant_id = #{tenantId}
    </update>

    <!-- 批量删除机器人执行记录（基于taskExecuteId） -->
    <update id="batchDeleteByTaskExecuteIds">
        update robot_execute_record 
        set deleted = 1,
            update_time = now(),
            updater_id = #{userId}
        where deleted = 0 
          and tenant_id = #{tenantId}
          and task_execute_id in
          <foreach collection="taskExecuteIdList" item="taskExecuteId" separator="," open="(" close=")">
              #{taskExecuteId}
          </foreach>
    </update>

    <!-- 批量删除机器人执行记录（基于executeId） -->
    <update id="deleteRobotExecuteRecords">
        update robot_execute_record
        set deleted = 1,
            update_time = now(),
            updater_id = #{userId}
        where deleted = 0
            and tenant_id = #{tenantId}
            and creator_id = #{userId}
            and execute_id in
        <foreach collection="recordsIds" item="recordId" separator="," open="(" close=")">
            #{recordId}
        </foreach>
    </update>

</mapper>
