<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iflytek.rpa.market.dao.AppMarketClassificationDao">

    <resultMap type="com.iflytek.rpa.market.entity.AppMarketClassification" id="AppMarketClassificationMap">
        <result property="id" column="id" jdbcType="BIGINT"/>
        <result property="name" column="name" jdbcType="VARCHAR"/>
        <result property="source" column="source" jdbcType="INTEGER"/>
        <result property="sort" column="sort" jdbcType="INTEGER"/>
        <result property="tenantId" column="tenant_id" jdbcType="VARCHAR"/>
        <result property="creatorId" column="creator_id" jdbcType="VARCHAR"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updaterId" column="updater_id" jdbcType="VARCHAR"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
        <result property="deleted" column="deleted" jdbcType="INTEGER"/>
    </resultMap>



    <select id="getClassificationListByTenantId"
            resultType="com.iflytek.rpa.market.entity.vo.AppMarketClassificationVo">
        SELECT
            id,
            name,
            sort
        FROM app_market_classification
        WHERE tenant_id = #{tenantId}
        AND deleted = 0
        ORDER BY sort ASC, create_time DESC
    </select>

    <select id="getClassificationManageList"
            resultType="com.iflytek.rpa.market.entity.dto.AppMarketClassificationManageVo">
        SELECT
            id,
            name,
            source
        FROM app_market_classification
        WHERE tenant_id = #{tenantId}
        AND deleted = 0
        <if test="name != null and name != ''">
            AND name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="source != null">
            AND source = #{source}
        </if>
        ORDER BY sort ASC, create_time DESC
    </select>

    <select id="getCategoryReferenceCount" resultType="java.util.Map">
        SELECT
            amv.category,
            COUNT(*) AS reference_count
        FROM
        app_market_version amv
        INNER JOIN (
            SELECT
                app_id,
                MAX(app_version) AS max_version
            FROM
                app_market_version
            WHERE
                deleted = 0
            GROUP BY app_id
        ) latest
        ON amv.app_id = latest.app_id
        AND amv.app_version = latest.max_version
        WHERE
            amv.deleted = 0
            AND amv.category IS NOT NULL
        GROUP BY amv.category
    </select>

    <insert id="insertDefaultClassification">
        INSERT INTO app_market_classification (name,source,sort,tenant_id,creator_id,create_time,updater_id,update_time,deleted)
        VALUES
        ('财务','0','1',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('教育','0','2',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('医疗','0','3',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('游戏','0','4',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('电商','0','5',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('直播','0','6',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('电信','0','7',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('政府/事业单位','0','8',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('生产制造','0','9',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('建筑/地产','0','10',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('烟草','0','11',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('运营','0','12',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('人事','0','13',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('城市服务','0','14',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('汽车业','0','15',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('人事','0','16',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('新能源','0','17',#{tenantId},NULL,now(),NULL,now(),'0'),
        ('其他','0','18',#{tenantId},NULL,now(),NULL,now(),'0')
    </insert>
</mapper>

